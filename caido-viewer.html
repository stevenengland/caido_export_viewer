<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Caido Export Viewer</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          sans-serif;
        background: #1a1a1a;
        color: #e0e0e0;
        line-height: 1.4;
      }

      .container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 20px;
      }

      .header {
        text-align: center;
        margin-bottom: 30px;
      }

      .header h1 {
        color: #4a9eff;
        margin-bottom: 10px;
      }

      .upload-area {
        border: 2px dashed #444;
        border-radius: 8px;
        padding: 40px;
        text-align: center;
        margin-bottom: 30px;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .upload-area:hover {
        border-color: #4a9eff;
        background: rgba(74, 158, 255, 0.05);
      }

      .upload-area.dragover {
        border-color: #4a9eff;
        background: rgba(74, 158, 255, 0.1);
      }

      .file-input {
        display: none;
      }

      .requests-table {
        width: 100%;
        border-collapse: collapse;
        background: #2a2a2a;
        border-radius: 8px;
        overflow: hidden;
        margin-bottom: 20px;
      }

      .requests-table th,
      .requests-table td {
        padding: 12px;
        text-align: left;
        border-bottom: 1px solid #444;
      }

      .requests-table th {
        background: #333;
        font-weight: 600;
        color: #ccc;
      }

      .requests-table tbody tr {
        cursor: pointer;
        transition: background-color 0.2s;
      }

      .requests-table tbody tr:hover {
        background: #3a3a3a;
      }

      .requests-table tbody tr.selected {
        background: #4a9eff20;
      }

      .method {
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 12px;
        font-weight: bold;
      }

      .method.GET {
        background: #28a745;
      }
      .method.POST {
        background: #ffc107;
        color: #000;
      }
      .method.PUT {
        background: #17a2b8;
      }
      .method.DELETE {
        background: #dc3545;
      }

      .status {
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 12px;
        font-weight: bold;
      }

      .status.success {
        background: #28a745;
      }
      .status.error {
        background: #dc3545;
      }
      .status.redirect {
        background: #ffc107;
        color: #000;
      }

      .details-panel {
        display: none;
        background: #2a2a2a;
        border-radius: 8px;
        padding: 20px;
        margin-top: 20px;
      }

      .details-panel.active {
        display: block;
      }

      .details-container {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 30px;
      }

      .details-section {
        background: #1a1a1a;
        border-radius: 8px;
        padding: 20px;
      }

      .details-section h2 {
        color: #4a9eff;
        margin-bottom: 20px;
        font-size: 1.5em;
        border-bottom: 2px solid #444;
        padding-bottom: 10px;
      }

      .details-section h3 {
        color: #ccc;
        margin: 20px 0 10px 0;
        font-size: 1.1em;
      }

      .code-block {
        background: #1a1a1a;
        border: 1px solid #444;
        border-radius: 4px;
        padding: 15px;
        font-family: "Courier New", monospace;
        font-size: 13px;
        overflow-x: auto;
        white-space: pre-wrap;
        word-break: break-all;
      }

      .info-grid {
        display: grid;
        grid-template-columns: 150px 1fr;
        gap: 10px;
        margin-bottom: 20px;
      }

      .info-label {
        font-weight: bold;
        color: #aaa;
      }

      .info-value {
        color: #e0e0e0;
      }

      .hidden {
        display: none;
      }

      .error {
        background: #dc3545;
        color: white;
        padding: 10px;
        border-radius: 4px;
        margin: 10px 0;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>Caido Export Viewer</h1>
        <p>Upload your Caido export JSON file to analyze HTTP requests</p>
      </div>

      <div class="upload-area" id="uploadArea">
        <p>Drop your Caido export JSON file here or click to select</p>
        <input type="file" id="fileInput" class="file-input" accept=".json" />
      </div>

      <div id="errorMessage" class="error hidden"></div>

      <div id="requestsContainer" class="hidden">
        <table class="requests-table">
          <thead>
            <tr>
              <th>ID</th>
              <th>Method</th>
              <th>Host</th>
              <th>Path</th>
              <th>Status</th>
              <th>Response Time</th>
              <th>Length</th>
            </tr>
          </thead>
          <tbody id="requestsTableBody"></tbody>
        </table>
      </div>

      <div id="detailsPanel" class="details-panel">
        <div class="details-container">
          <div class="details-section">
            <h2>Request</h2>
            <div class="info-grid" id="requestInfo"></div>
            <h3>Raw Request</h3>
            <div class="code-block" id="rawRequest"></div>
            <h3>Request Headers</h3>
            <div class="code-block" id="requestHeaders"></div>
          </div>

          <div class="details-section">
            <h2>Response</h2>
            <div class="info-grid" id="responseInfo"></div>
            <h3>Raw Response</h3>
            <div class="code-block" id="rawResponse"></div>
            <h3>Response Headers</h3>
            <div class="code-block" id="responseHeaders"></div>
          </div>
        </div>
      </div>
    </div>

    <script>
      let requests = [];
      let selectedRequest = null;

      const uploadArea = document.getElementById("uploadArea");
      const fileInput = document.getElementById("fileInput");
      const errorMessage = document.getElementById("errorMessage");
      const requestsContainer = document.getElementById("requestsContainer");
      const requestsTableBody = document.getElementById("requestsTableBody");
      const detailsPanel = document.getElementById("detailsPanel");

      // File upload handlers
      uploadArea.addEventListener("click", () => fileInput.click());
      uploadArea.addEventListener("dragover", handleDragOver);
      uploadArea.addEventListener("drop", handleDrop);
      uploadArea.addEventListener("dragleave", handleDragLeave);
      fileInput.addEventListener("change", handleFileSelect);

      function handleDragOver(e) {
        e.preventDefault();
        uploadArea.classList.add("dragover");
      }

      function handleDragLeave(e) {
        e.preventDefault();
        uploadArea.classList.remove("dragover");
      }

      function handleDrop(e) {
        e.preventDefault();
        uploadArea.classList.remove("dragover");
        const files = e.dataTransfer.files;
        if (files.length > 0) {
          processFile(files[0]);
        }
      }

      function handleFileSelect(e) {
        const files = e.target.files;
        if (files.length > 0) {
          processFile(files[0]);
        }
      }

      function processFile(file) {
        if (!file.name.endsWith(".json")) {
          showError("Please select a JSON file");
          return;
        }

        const reader = new FileReader();
        reader.onload = function (e) {
          try {
            const data = JSON.parse(e.target.result);
            if (Array.isArray(data)) {
              requests = data;
              displayRequests();
              hideError();
            } else {
              showError("Invalid JSON format. Expected an array of requests.");
            }
          } catch (error) {
            showError("Error parsing JSON file: " + error.message);
          }
        };
        reader.readAsText(file);
      }

      function showError(message) {
        errorMessage.textContent = message;
        errorMessage.classList.remove("hidden");
      }

      function hideError() {
        errorMessage.classList.add("hidden");
      }

      function displayRequests() {
        requestsTableBody.innerHTML = "";

        requests.forEach((request, index) => {
          const row = document.createElement("tr");
          row.innerHTML = `
                    <td>${request.id || index}</td>
                    <td><span class="method ${request.method}">${
            request.method
          }</span></td>
                    <td>${request.host}</td>
                    <td>${request.path}</td>
                    <td><span class="status ${getStatusClass(
                      request.response?.status_code
                    )}">${request.response?.status_code || "N/A"}</span></td>
                    <td>${formatResponseTime(request.response?.length)} ms</td>
                    <td>${request.length || "N/A"}</td>
                `;

          row.addEventListener("click", () => selectRequest(index, row));
          requestsTableBody.appendChild(row);
        });

        requestsContainer.classList.remove("hidden");
      }

      function getStatusClass(status) {
        if (!status) return "";
        if (status >= 200 && status < 300) return "success";
        if (status >= 300 && status < 400) return "redirect";
        if (status >= 400) return "error";
        return "";
      }

      function formatResponseTime(time) {
        return time ? time.toString() : "N/A";
      }

      function selectRequest(index, rowElement) {
        // Remove previous selection
        document.querySelectorAll(".requests-table tbody tr").forEach((row) => {
          row.classList.remove("selected");
        });

        // Add selection to current row
        rowElement.classList.add("selected");

        selectedRequest = requests[index];
        displayRequestDetails();
        detailsPanel.classList.add("active");
      }

      function displayRequestDetails() {
        if (!selectedRequest) return;

        // Request info
        const requestInfo = document.getElementById("requestInfo");
        requestInfo.innerHTML = `
                <div class="info-label">Method:</div>
                <div class="info-value">${selectedRequest.method}</div>
                <div class="info-label">Host:</div>
                <div class="info-value">${selectedRequest.host}:${
          selectedRequest.port
        }</div>
                <div class="info-label">Path:</div>
                <div class="info-value">${selectedRequest.path}</div>
                <div class="info-label">TLS:</div>
                <div class="info-value">${
                  selectedRequest.is_tls ? "Yes" : "No"
                }</div>
                <div class="info-label">Length:</div>
                <div class="info-value">${selectedRequest.length} bytes</div>
            `;

        // Raw request
        const rawRequest = document.getElementById("rawRequest");
        rawRequest.textContent = selectedRequest.raw
          ? atob(selectedRequest.raw)
          : "Raw request data not available";

        // Response info
        const responseInfo = document.getElementById("responseInfo");
        if (selectedRequest.response) {
          responseInfo.innerHTML = `
                    <div class="info-label">Status:</div>
                    <div class="info-value">${selectedRequest.response.status_code}</div>
                    <div class="info-label">Length:</div>
                    <div class="info-value">${selectedRequest.response.length} bytes</div>
                `;
        } else {
          responseInfo.innerHTML =
            '<div class="info-value">No response data available</div>';
        }

        // Raw response
        const rawResponse = document.getElementById("rawResponse");
        if (selectedRequest.response && selectedRequest.response.raw) {
          rawResponse.textContent = atob(selectedRequest.response.raw);
        } else {
          rawResponse.textContent = "Raw response data not available";
        }

        // Headers
        updateHeaders();
      }

      function updateHeaders() {
        const requestHeaders = document.getElementById("requestHeaders");
        const responseHeaders = document.getElementById("responseHeaders");

        // Parse request headers from raw data
        if (selectedRequest.raw) {
          try {
            const decodedRequest = atob(selectedRequest.raw);
            const headerEnd = decodedRequest.indexOf("\r\n\r\n");
            if (headerEnd !== -1) {
              const headerSection = decodedRequest.substring(0, headerEnd);
              requestHeaders.textContent = headerSection;
            } else {
              requestHeaders.textContent = "Could not parse request headers";
            }
          } catch (e) {
            requestHeaders.textContent = "Error parsing request headers";
          }
        } else {
          requestHeaders.textContent = "Request headers not available";
        }

        // Parse response headers from raw data
        if (selectedRequest.response && selectedRequest.response.raw) {
          try {
            const decodedResponse = atob(selectedRequest.response.raw);
            const headerEnd = decodedResponse.indexOf("\r\n\r\n");
            if (headerEnd !== -1) {
              const headerSection = decodedResponse.substring(0, headerEnd);
              responseHeaders.textContent = headerSection;
            } else {
              responseHeaders.textContent = "Could not parse response headers";
            }
          } catch (e) {
            responseHeaders.textContent = "Error parsing response headers";
          }
        } else {
          responseHeaders.textContent = "Response headers not available";
        }
      }
    </script>
  </body>
</html>
