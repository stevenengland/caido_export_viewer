<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Caido Export Viewer</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        background: #1a1a1a;
        color: #e0e0e0;
        line-height: 1.2;
        font-size: 13px;
      }

      .container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 12px;
      }

      .header {
        text-align: center;
        margin-bottom: 30px;
      }

      .header h1 {
        color: #4a9eff;
        margin-bottom: 8px;
        font-size: 1.3em;
      }

      .upload-area {
        border: 2px dashed #444;
        border-radius: 8px;
        padding: 18px;
        text-align: center;
        margin-bottom: 18px;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 12px;
      }

      .upload-area:hover {
        border-color: #4a9eff;
        background: rgba(74, 158, 255, 0.05);
      }

      .upload-area.dragover {
        border-color: #4a9eff;
        background: rgba(74, 158, 255, 0.1);
      }

      .file-input {
        display: none;
      }

      .requests-table {
        width: 100%;
        border-collapse: collapse;
        background: #2a2a2a;
        border-radius: 8px;
        overflow: hidden;
        margin-bottom: 12px;
        table-layout: fixed;
        font-size: 12px;
      }

      .requests-table th,
      .requests-table td {
        padding: 4px 6px;
        text-align: left;
        border-bottom: 1px solid #444;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        font-size: 12px;
      }

      .requests-table th {
        background: #333;
        font-weight: 600;
        color: #ccc;
        position: relative;
        user-select: none;
        font-size: 12px;
      }

      .col-resizer {
        position: absolute;
        right: 0;
        top: 0;
        width: 6px;
        height: 100%;
        cursor: col-resize;
        z-index: 2;
        background: transparent;
        transition: background 0.2s;
      }

      .col-resizer:hover {
        background: #4a9eff44;
      }

      .requests-table tbody tr {
        cursor: pointer;
        transition: background-color 0.2s;
      }

      .requests-table tbody tr:hover {
        background: #3a3a3a;
      }

      .requests-table tbody tr.selected {
        background: #4a9eff20;
      }

      .method {
        padding: 2px 6px;
        border-radius: 4px;
        font-size: 11px;
        font-weight: bold;
      }

      .method.GET {
        background: #28a745;
      }
      .method.POST {
        background: #ffc107;
        color: #000;
      }
      .method.PUT {
        background: #17a2b8;
      }
      .method.DELETE {
        background: #dc3545;
      }

      .status {
        padding: 2px 6px;
        border-radius: 4px;
        font-size: 11px;
        font-weight: bold;
      }

      .status.success {
        background: #28a745;
      }
      .status.error {
        background: #dc3545;
      }
      .status.redirect {
        background: #ffc107;
        color: #000;
      }

      .details-panel {
        display: none;
        background: #2a2a2a;
        border-radius: 8px;
        padding: 12px;
        margin-top: 12px;
        font-size: 12px;
      }

      .details-panel.active {
        display: block;
      }

      .details-container {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 30px;
      }

      .details-section {
        background: #1a1a1a;
        border-radius: 8px;
        padding: 20px;
      }

      .details-section h2 {
        color: #4a9eff;
        margin-bottom: 10px;
        font-size: 1.1em;
        border-bottom: 2px solid #444;
        padding-bottom: 6px;
      }

      .details-section h3 {
        color: #ccc;
        margin: 10px 0 6px 0;
        font-size: 1em;
      }

      .code-block {
        background: #1a1a1a;
        border: 1px solid #444;
        border-radius: 4px;
        padding: 8px;
        font-family: "Courier New", monospace;
        font-size: 11px;
        overflow-x: auto;
        white-space: pre-wrap;
        word-break: break-all;
      }

      .info-grid {
        display: grid;
        grid-template-columns: 120px 1fr;
        gap: 6px;
        margin-bottom: 10px;
        font-size: 12px;
      }

      .info-label {
        font-weight: bold;
        color: #aaa;
        font-size: 12px;
      }

      .info-value {
        color: #e0e0e0;
        font-size: 12px;
      }

      .hidden {
        display: none;
      }

      .error {
        background: #dc3545;
        color: white;
        padding: 10px;
        border-radius: 4px;
        margin: 10px 0;
      }

      /* Fix scrollable requests table to fill width */
      .scrollable-requests-wrapper {
        max-height: 240px;
        overflow-y: auto;
        width: 100%;
      }
      .scrollable-requests {
        /* Remove display:block, let it be default */
      }
      .scrollable-requests tr {
        /* Remove display:table, let it be default */
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>Caido Export Viewer</h1>
        <p>Upload your Caido export JSON file to analyze HTTP requests</p>
      </div>

      <div class="upload-area" id="uploadArea">
        <p>Drop your Caido export JSON file here or click to select</p>
        <input type="file" id="fileInput" class="file-input" accept=".json" />
      </div>

      <div id="errorMessage" class="error hidden"></div>
      <div id="hostFilterContainer" class="hidden"></div>
      </div>
      <div id="requestsContainer" class="hidden">
        <div id="requestsToolbox" style="display:flex;align-items:center;gap:12px;margin-bottom:6px;">
          <button id="exportSelectedBtn" style="background:#23272e;color:#4a9eff;border:1px solid #4a9eff;border-radius:4px;padding:3px 12px;font-size:12px;cursor:pointer;">Export Selected</button>
        </div>
        <table class="requests-table" id="mainRequestsTable">
          <colgroup id="mainColgroup">
            <col style="width: 7%" />
            <col style="width: 10%" />
            <col style="width: 18%" />
            <col style="width: 25%" />
            <col style="width: 10%" />
            <col style="width: 15%" />
            <col style="width: 15%" />
          </colgroup>
          <thead>
            <tr>
              <th style="width:4%;text-align:center;padding:0 2px;">
                <input type="checkbox" id="selectAllRequests" checked style="margin:0;vertical-align:middle;" title="Select all" />
              </th>
              <th>
                ID
                <div class="col-resizer"></div>
              </th>
              <th>
                Method
                <div class="col-resizer"></div>
              </th>
              <th style="position:relative;">
                Host
                <button id="hostFilterBtn" title="Filter hosts" style="background:none;border:none;cursor:pointer;padding:0 4px;vertical-align:middle;outline:none;">
                  <span style="font-size:16px;color:#4a9eff;">&#128269;</span>
                </button>
                <div class="col-resizer"></div>
              </th>
              <th>
                Path
                <div class="col-resizer"></div>
              </th>
              <th>
                Status
                <div class="col-resizer"></div>
              </th>
              <th>
                Response Time
                <div class="col-resizer"></div>
              </th>
              <th>
                Length
              </th>
            </tr>
          </thead>
        </table>
        <div id="requestsTableBodyWrapper">
          <table
            class="requests-table"
            style="border-top: none; table-layout: fixed; width: 100%"
          >
            <colgroup id="bodyColgroup">
              <col style="width: 7%" />
              <col style="width: 10%" />
              <col style="width: 18%" />
              <col style="width: 25%" />
              <col style="width: 10%" />
              <col style="width: 15%" />
              <col style="width: 15%" />
            </colgroup>
            <tbody id="requestsTableBody"></tbody>
          </table>
        </div>
      </div>

      <div id="detailsPanel" class="details-panel">
        <div class="details-container">
          <div class="details-section">
            <h2>Request</h2>
            <div class="info-grid" id="requestInfo"></div>
            <div
              style="
                display: flex;
                align-items: center;
                gap: 10px;
                margin-top: 20px;
              "
            >
              <h3 style="margin: 0">Request Headers</h3>
              <button
                class="copy-btn"
                id="copyRequestHeadersBtn"
                title="Copy headers to clipboard"
              >
                ðŸ“‹
              </button>
            </div>
            <div class="code-block" id="requestHeaders"></div>
            <div
              style="
                display: flex;
                align-items: center;
                gap: 10px;
                margin-top: 20px;
              "
            >
              <h3 style="margin: 0">Request Body</h3>
              <button
                class="copy-btn"
                id="copyRequestBodyBtn"
                title="Copy body to clipboard"
              >
                ðŸ“‹
              </button>
            </div>
            <div class="code-block" id="requestBody"></div>
          </div>

          <div class="details-section">
            <h2>Response</h2>
            <div class="info-grid" id="responseInfo"></div>
            <div
              style="
                display: flex;
                align-items: center;
                gap: 10px;
                margin-top: 20px;
              "
            >
              <h3 style="margin: 0">Response Headers</h3>
              <button
                class="copy-btn"
                id="copyResponseHeadersBtn"
                title="Copy headers to clipboard"
              >
                ðŸ“‹
              </button>
            </div>
            <div class="code-block" id="responseHeaders"></div>
            <div
              style="
                display: flex;
                align-items: center;
                gap: 10px;
                margin-top: 20px;
              "
            >
              <h3 style="margin: 0">Response Body</h3>
              <button
                class="copy-btn"
                id="copyResponseBodyBtn"
                title="Copy body to clipboard"
              >
                ðŸ“‹
              </button>
            </div>
            <div class="code-block" id="responseBody"></div>
          </div>
        </div>
      </div>
    </div>

    <script>
      let requests = [];
      let selectedRequest = null;

      const uploadArea = document.getElementById("uploadArea");
      const fileInput = document.getElementById("fileInput");
      const errorMessage = document.getElementById("errorMessage");
      const requestsContainer = document.getElementById("requestsContainer");
      const requestsTableBody = document.getElementById("requestsTableBody");
      const detailsPanel = document.getElementById("detailsPanel");

      // File upload handlers
      uploadArea.addEventListener("click", () => fileInput.click());
      uploadArea.addEventListener("dragover", handleDragOver);
      uploadArea.addEventListener("drop", handleDrop);
      uploadArea.addEventListener("dragleave", handleDragLeave);
      fileInput.addEventListener("change", handleFileSelect);

      function handleDragOver(e) {
        e.preventDefault();
        uploadArea.classList.add("dragover");
      }

      function handleDragLeave(e) {
        e.preventDefault();
        uploadArea.classList.remove("dragover");
      }

      function handleDrop(e) {
        e.preventDefault();
        uploadArea.classList.remove("dragover");
        const files = e.dataTransfer.files;
        if (files.length > 0) {
          processFile(files[0]);
        }
      }

      function handleFileSelect(e) {
        const files = e.target.files;
        if (files.length > 0) {
          processFile(files[0]);
        }
      }

      function processFile(file) {
        if (!file.name.endsWith(".json")) {
          showError("Please select a JSON file");
          return;
        }

        const reader = new FileReader();
        reader.onload = function (e) {
          try {
            const data = JSON.parse(e.target.result);
            if (Array.isArray(data)) {
              requests = data;
              setupHostFilter();
              displayRequests();
              hideError();
            } else {
              showError("Invalid JSON format. Expected an array of requests.");
            }
          } catch (error) {
            showError("Error parsing JSON file: " + error.message);
          }
        };
        reader.readAsText(file);
      }

      function showError(message) {
        errorMessage.textContent = message;
        errorMessage.classList.remove("hidden");
      }

      function hideError() {
        errorMessage.classList.add("hidden");
      }

      // --- Host filtering state ---
      let hostFilterRegex = "";
      let hostFilterSelected = [];
      let allHosts = [];
      let hostFilterPopupOpen = false;

      // --- Selection state ---
      let selectedRequestIds = new Set();

      function syncColgroupWidths() {
        // Sync colgroup widths between header and body tables
        const mainColgroup = document.getElementById('mainColgroup');
        const bodyColgroup = document.getElementById('bodyColgroup');
        if (!mainColgroup || !bodyColgroup) return;
        for (let i = 0; i < mainColgroup.children.length; ++i) {
          const w = mainColgroup.children[i].style.width;
          if (bodyColgroup.children[i]) bodyColgroup.children[i].style.width = w;
        }
      }

      function displayRequests() {
        requestsTableBody.innerHTML = "";

        // Filter requests by host
        let filteredRequests = requests.filter((req) => {
          let host = req.host || "";
          // Regex filter
          let regexOk = true;
          if (hostFilterRegex) {
            try {
              regexOk = new RegExp(hostFilterRegex, "i").test(host);
            } catch {
              regexOk = true; // ignore invalid regex
            }
          }
          // Checkbox filter
          let selectedOk =
            hostFilterSelected.length === 0 ||
            hostFilterSelected.includes(host);
          return regexOk && selectedOk;
        });

        // If no selection state yet, select all filtered
        if (selectedRequestIds.size === 0 && filteredRequests.length > 0) {
          filteredRequests.forEach((req, idx) => {
            selectedRequestIds.add(req.id !== undefined ? req.id : idx);
          });
        }

        // Toggle scrollable class if more than 10 entries
        const wrapper = document.getElementById("requestsTableBodyWrapper");
        if (filteredRequests.length > 10) {
          requestsTableBody.classList.add("scrollable-requests");
          if (wrapper) wrapper.classList.add("scrollable-requests-wrapper");
        } else {
          requestsTableBody.classList.remove("scrollable-requests");
          if (wrapper) wrapper.classList.remove("scrollable-requests-wrapper");
        }

        filteredRequests.forEach((request, index) => {
          const row = document.createElement("tr");
          
          // Store reference to original request object for easier access
          row.__requestObj = request;
          row.__originalIndex = requests.indexOf(request);

          // Selection checkbox
          const tdCheck = document.createElement("td");
          tdCheck.style.textAlign = "center";
          const cb = document.createElement("input");
          cb.type = "checkbox";
          cb.checked = selectedRequestIds.has(request.id !== undefined ? request.id : row.__originalIndex);
          cb.style.margin = "0";
          cb.onclick = function(e) {
            e.stopPropagation();
            const rid = request.id !== undefined ? request.id : row.__originalIndex;
            if (cb.checked) {
              selectedRequestIds.add(rid);
            } else {
              selectedRequestIds.delete(rid);
            }
            // Update select all checkbox
            updateSelectAllCheckbox();
          };
          tdCheck.appendChild(cb);
          row.appendChild(tdCheck);

          // ID
          const tdId = document.createElement("td");
          tdId.textContent = request.id || index;
          row.appendChild(tdId);

          // Method
          const tdMethod = document.createElement("td");
          const methodSpan = document.createElement("span");
          methodSpan.className = "method " + (request.method || "");
          methodSpan.textContent = request.method || "";
          tdMethod.appendChild(methodSpan);
          row.appendChild(tdMethod);

          // Host
          const tdHost = document.createElement("td");
          tdHost.textContent = request.host || "";
          row.appendChild(tdHost);

          // Path
          const tdPath = document.createElement("td");
          tdPath.textContent = request.path || "";
          row.appendChild(tdPath);

          // Status
          const tdStatus = document.createElement("td");
          const statusSpan = document.createElement("span");
          const statusCode = request.response && request.response.status_code;
          statusSpan.className = "status " + getStatusClass(statusCode);
          statusSpan.textContent = statusCode || "N/A";
          tdStatus.appendChild(statusSpan);
          row.appendChild(tdStatus);

          // Response Time
          const tdRespTime = document.createElement("td");
          const responseTime = calculateResponseTime(request);
          tdRespTime.textContent = responseTime;
          if (responseTime !== "N/A") {
            tdRespTime.appendChild(document.createTextNode(" ms"));
          }
          row.appendChild(tdRespTime);

          // Length
          const tdLength = document.createElement("td");
          tdLength.textContent = request.length || "N/A";
          row.appendChild(tdLength);

          row.addEventListener("click", () =>
            selectRequest(row.__originalIndex, row)
          );
          requestsTableBody.appendChild(row);
        });

        requestsContainer.classList.remove("hidden");
        // Hide host filter popup if open
        if (!hostFilterPopupOpen) {
          document.getElementById("hostFilterContainer").classList.add("hidden");
        }
        updateSelectAllCheckbox();
        setupExportButton(filteredRequests);
        syncColgroupWidths();
      }

      function updateSelectAllCheckbox() {
        const selectAll = document.getElementById('selectAllRequests');
        if (!selectAll) return;
        // Get all visible checkboxes
        const visibleCbs = Array.from(requestsTableBody.querySelectorAll('tr input[type="checkbox"]'));
        const allChecked = visibleCbs.length > 0 && visibleCbs.every(cb => cb.checked);
        selectAll.checked = allChecked;
        selectAll.indeterminate = !allChecked && visibleCbs.some(cb => cb.checked);
        selectAll.onclick = function(e) {
          e.stopPropagation();
          visibleCbs.forEach(cb => {
            cb.checked = selectAll.checked;
            const row = cb.closest('tr');
            const request = row.__requestObj;
            const rid = request && (request.id !== undefined ? request.id : row.__originalIndex);
            if (selectAll.checked && rid !== undefined) {
              selectedRequestIds.add(rid);
            } else if (rid !== undefined) {
              selectedRequestIds.delete(rid);
            }
          });
        };
      }

      function setupExportButton(filteredRequests) {
        const btn = document.getElementById('exportSelectedBtn');
        if (!btn) return;
        btn.onclick = function() {
          // Export only visible (filtered) and checked
          const visibleRows = Array.from(requestsTableBody.children);
          const exportRows = [];
          visibleRows.forEach((tr, idx) => {
            const cb = tr.querySelector('input[type="checkbox"]');
            if (cb && cb.checked) {
              // Use the stored request reference
              const req = tr.__requestObj;
              if (req) exportRows.push(req);
            }
          });
          const json = JSON.stringify(exportRows, null, 2);
          const blob = new Blob([json], {type: 'application/json'});
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = 'caido_export_filtered_selected.json';
          document.body.appendChild(a);
          a.click();
          setTimeout(() => {
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
          }, 100);
        };
      }

      function setupHostFilter() {
        // Get all unique hosts
        allHosts = Array.from(
          new Set(requests.map((r) => r.host || "").filter((h) => h))
        ).sort();
        hostFilterSelected = [...allHosts];
        hostFilterRegex = "";
        renderHostFilterUI();
      }

      function renderHostFilterUI() {
        // Render popup overlay
        const container = document.getElementById("hostFilterContainer");
        container.innerHTML = "";
        if (!hostFilterPopupOpen) {
          container.classList.add("hidden");
          return;
        }
        container.classList.remove("hidden");
        // Overlay background
        const overlay = document.createElement("div");
        overlay.style.position = "fixed";
        overlay.style.top = "0";
        overlay.style.left = "0";
        overlay.style.width = "100vw";
        overlay.style.height = "100vh";
        overlay.style.background = "rgba(0,0,0,0.25)";
        overlay.style.zIndex = "1000";
        overlay.onclick = function(e) {
          if (e.target === overlay) {
            hostFilterPopupOpen = false;
            renderHostFilterUI();
          }
        };
        container.appendChild(overlay);

        // --- Resizable popup state ---
        // Store popup size in a variable (persist across renders)
        if (!window._hostFilterPopupSize) {
          window._hostFilterPopupSize = { width: 380, height: 340 };
        }
        const popupSize = window._hostFilterPopupSize;

        // Popup panel
        const popup = document.createElement("div");
        popup.style.position = "fixed";
        popup.style.top = "90px";
        popup.style.left = "50%";
        popup.style.transform = "translateX(-50%)";
        popup.style.background = "#23272e";
        popup.style.border = "1.5px solid #4a9eff";
        popup.style.borderRadius = "10px";
        popup.style.padding = "28px 32px 22px 32px";
        popup.style.zIndex = "1001";
        popup.style.minWidth = "340px";
        popup.style.minHeight = "220px";
        popup.style.resize = "none";
        popup.style.boxShadow = "0 8px 32px #000a";
        popup.style.width = popupSize.width + "px";
        popup.style.height = popupSize.height + "px";
        popup.style.overflow = "hidden";
        popup.style.display = "flex";
        popup.style.flexDirection = "column";

        // Title and close
        const titleRow = document.createElement("div");
        titleRow.style.display = "flex";
        titleRow.style.justifyContent = "space-between";
        titleRow.style.alignItems = "center";
        titleRow.style.marginBottom = "18px";
        const title = document.createElement("span");
        title.textContent = "Host Filter";
        title.style.fontWeight = "bold";
        title.style.fontSize = "1.15em";
        title.style.color = "#4a9eff";
        titleRow.appendChild(title);
        const closeBtn = document.createElement("button");
        closeBtn.innerHTML = "&#10006;";
        closeBtn.title = "Close";
        closeBtn.style.background = "none";
        closeBtn.style.border = "none";
        closeBtn.style.color = "#aaa";
        closeBtn.style.fontSize = "1.2em";
        closeBtn.style.cursor = "pointer";
        closeBtn.onclick = function() {
          hostFilterPopupOpen = false;
          renderHostFilterUI();
        };
        titleRow.appendChild(closeBtn);
        popup.appendChild(titleRow);

        // Regex input
        const regexDiv = document.createElement("div");
        regexDiv.style.marginBottom = "12px";
        regexDiv.innerHTML = `
          <label style="font-weight:bold; color:#4a9eff;">Host filter (regex): </label>
          <input type="text" id="hostRegexInput" style="width:220px; margin-right:10px;" placeholder="Regex (case-insensitive)" value="${hostFilterRegex.replace(/"/g, '&quot;')}">
        `;
        popup.appendChild(regexDiv);

        // Host checkbox list
        const listDiv = document.createElement("div");
        listDiv.style.flex = "1 1 auto";
        listDiv.style.minHeight = "80px";
        listDiv.style.maxHeight = "100%";
        listDiv.style.overflowY = "auto";
        listDiv.style.background = "#222";
        listDiv.style.border = "1px solid #444";
        listDiv.style.borderRadius = "4px";
        listDiv.style.padding = "8px 12px";
        listDiv.style.marginBottom = '10px';

        // --- Scroll position preservation ---
        // Restore scroll position if available
        if (window._hostFilterListScrollTop !== undefined) {
          setTimeout(() => { listDiv.scrollTop = window._hostFilterListScrollTop; }, 0);
        }

        // Select all checkbox
        const selectAllId = 'hostSelectAll';
        const selectAll = document.createElement('input');
        selectAll.type = 'checkbox';
        selectAll.id = selectAllId;
        selectAll.checked = hostFilterSelected.length === allHosts.length;
        selectAll.style.marginRight = '6px';
        const selectAllLabel = document.createElement('label');
        selectAllLabel.htmlFor = selectAllId;
        selectAllLabel.textContent = 'Select All';
        selectAllLabel.style.fontWeight = 'bold';
        listDiv.appendChild(selectAll);
        listDiv.appendChild(selectAllLabel);
        listDiv.appendChild(document.createElement('br'));

        selectAll.addEventListener('change', function() {
          window._hostFilterListScrollTop = listDiv.scrollTop;
          if (this.checked) {
            hostFilterSelected = [...allHosts];
          } else {
            hostFilterSelected = [];
          }
          renderHostFilterUI();
          displayRequests();
        });

        // Host checkboxes
        allHosts.forEach(host => {
          const id = 'hostcb_' + btoa(host).replace(/[^a-z0-9]/gi, '');
          const cb = document.createElement('input');
          cb.type = 'checkbox';
          cb.id = id;
          cb.value = host;
          cb.checked = hostFilterSelected.includes(host);
          cb.style.marginRight = '6px';
          cb.addEventListener('change', function() {
            window._hostFilterListScrollTop = listDiv.scrollTop;
            if (this.checked) {
              if (!hostFilterSelected.includes(host)) hostFilterSelected.push(host);
            } else {
              hostFilterSelected = hostFilterSelected.filter((h) => h !== host);
            }
            renderHostFilterUI();
            displayRequests();
          });
          const label = document.createElement('label');
          label.htmlFor = id;
          label.textContent = host;
          label.style.marginRight = '6px';
          listDiv.appendChild(cb);
          listDiv.appendChild(label);
          listDiv.appendChild(document.createElement('br'));
        });
        popup.appendChild(listDiv);

        // Regex input event
        const regexInput = popup.querySelector('#hostRegexInput');
        regexInput.addEventListener('input', function() {
          window._hostFilterListScrollTop = listDiv.scrollTop;
          hostFilterRegex = this.value;
          displayRequests();
        });

        // --- Resizable handle ---
        const resizeHandle = document.createElement('div');
        resizeHandle.style.position = 'absolute';
        resizeHandle.style.right = '2px';
        resizeHandle.style.bottom = '2px';
        resizeHandle.style.width = '18px';
        resizeHandle.style.height = '18px';
        resizeHandle.style.cursor = 'nwse-resize';
        resizeHandle.style.background = 'linear-gradient(135deg, transparent 60%, #4a9eff 100%)';
        resizeHandle.title = 'Resize';
        popup.appendChild(resizeHandle);

        let resizing = false, startX, startY, startW, startH;
        resizeHandle.addEventListener('mousedown', function(e) {
          e.preventDefault();
          resizing = true;
          startX = e.clientX;
          startY = e.clientY;
          startW = popup.offsetWidth;
          startH = popup.offsetHeight;
          document.body.style.userSelect = 'none';
        });
        document.addEventListener('mousemove', function(e) {
          if (!resizing) return;
          let newW = Math.max(320, startW + (e.clientX - startX));
          let newH = Math.max(180, startH + (e.clientY - startY));
          popup.style.width = newW + 'px';
          popup.style.height = newH + 'px';
        });
        document.addEventListener('mouseup', function(e) {
          if (resizing) {
            resizing = false;
            window._hostFilterPopupSize.width = popup.offsetWidth;
            window._hostFilterPopupSize.height = popup.offsetHeight;
            document.body.style.userSelect = '';
          }
        });

        container.appendChild(popup);
      }

      function getStatusClass(status) {
        if (!status) return "";
        if (status >= 200 && status < 300) return "success";
        if (status >= 300 && status < 400) return "redirect";
        if (status >= 400) return "error";
        return "";
      }

      function calculateResponseTime(request) {
        if (request.response && request.created_at && request.response.created_at) {
          const requestTime = new Date(request.created_at);
          const responseTime = new Date(request.response.created_at);
          const diff = responseTime - requestTime;
          return diff >= 0 ? diff.toString() : "N/A";
        }
        return "N/A";
      }

      function formatResponseTime(time) {
        return time ? time.toString() : "N/A";
      }

      function selectRequest(index, rowElement) {
        // Remove previous selection
        document.querySelectorAll(".requests-table tbody tr").forEach((row) => {
          row.classList.remove("selected");
        });

        // Add selection to current row
        rowElement.classList.add("selected");

        selectedRequest = requests[index];
        displayRequestDetails();
        detailsPanel.classList.add("active");
      }

      function displayRequestDetails() {
        if (!selectedRequest) return;

        // Request info
        const requestInfo = document.getElementById("requestInfo");
        requestInfo.innerHTML = `
                <div class="info-label">Method:</div>
                <div class="info-value">${selectedRequest.method}</div>
                <div class="info-label">Host:</div>
                <div class="info-value">${selectedRequest.host}:${
          selectedRequest.port
        }</div>
                <div class="info-label">Path:</div>
                <div class="info-value">${selectedRequest.path}</div>
                <div class="info-label">TLS:</div>
                <div class="info-value">${
                  selectedRequest.is_tls ? "Yes" : "No"
                }</div>
                <div class="info-label">Length:</div>
                <div class="info-value">${selectedRequest.length} bytes</div>
            `;

        // Response info
        const responseInfo = document.getElementById("responseInfo");
        if (selectedRequest.response) {
          responseInfo.innerHTML = `
                    <div class="info-label">Status:</div>
                    <div class="info-value">${selectedRequest.response.status_code}</div>
                    <div class="info-label">Length:</div>
                    <div class="info-value">${selectedRequest.response.length} bytes</div>
                `;
        } else {
          responseInfo.innerHTML =
            '<div class="info-value">No response data available</div>';
        }

        // Headers and Bodies
        updateHeadersAndBodies();

        // Setup copy buttons
        setTimeout(() => {
          const copyRequestHeadersBtn = document.getElementById(
            "copyRequestHeadersBtn"
          );
          const copyRequestBodyBtn =
            document.getElementById("copyRequestBodyBtn");
          const copyResponseHeadersBtn = document.getElementById(
            "copyResponseHeadersBtn"
          );
          const copyResponseBodyBtn = document.getElementById(
            "copyResponseBodyBtn"
          );
          const requestHeaders = document.getElementById("requestHeaders");
          const requestBody = document.getElementById("requestBody");
          const responseHeaders = document.getElementById("responseHeaders");
          const responseBody = document.getElementById("responseBody");

          if (copyRequestHeadersBtn)
            copyRequestHeadersBtn.onclick = () =>
              copyToClipboard(requestHeaders.textContent);
          if (copyRequestBodyBtn)
            copyRequestBodyBtn.onclick = () =>
              copyToClipboard(requestBody.textContent);
          if (copyResponseHeadersBtn)
            copyResponseHeadersBtn.onclick = () =>
              copyToClipboard(responseHeaders.textContent);
          if (copyResponseBodyBtn)
            copyResponseBodyBtn.onclick = () =>
              copyToClipboard(responseBody.textContent);
        }, 0);
      }

      function prettifyContent(content, headers = "") {
        if (!content || content.trim() === "") {
          return content;
        }

        // Try to detect content type from headers
        const contentType = headers.toLowerCase();

        // Try JSON formatting
        if (
          contentType.includes("application/json") ||
          contentType.includes("text/json") ||
          content.trim().startsWith("{") ||
          content.trim().startsWith("[")
        ) {
          try {
            const parsed = JSON.parse(content);
            return JSON.stringify(parsed, null, 2);
          } catch (e) {
            // Not valid JSON, continue to other formats
          }
        }

        // Try XML formatting
        if (
          contentType.includes("application/xml") ||
          contentType.includes("text/xml") ||
          content.trim().startsWith("<?xml") ||
          content.trim().startsWith("<")
        ) {
          try {
            return formatXML(content);
          } catch (e) {
            // Not valid XML, return original
          }
        }

        // For URL-encoded data
        if (contentType.includes("application/x-www-form-urlencoded")) {
          try {
            const params = new URLSearchParams(content);
            const formatted = [];
            for (const [key, value] of params) {
              formatted.push(`${key} = ${value}`);
            }
            return formatted.join("\n");
          } catch (e) {
            // Return original if parsing fails
          }
        }

        return content;
      }

      function formatXML(xml) {
        const PADDING = "  ";
        const reg = /(>)(<)(\/*)/g;
        let formatted = xml.replace(reg, "$1\r\n$2$3");
        let pad = 0;

        return formatted
          .split("\r\n")
          .map((line) => {
            let indent = 0;
            if (line.match(/.+<\/\w[^>]*>$/)) {
              indent = 0;
            } else if (line.match(/^<\/\w/) && pad > 0) {
              pad -= 1;
            } else if (line.match(/^<\w[^>]*[^\/]>.*$/)) {
              indent = 1;
            } else {
              indent = 0;
            }

            const padding = PADDING.repeat(pad);
            pad += indent;
            return padding + line;
          })
          .join("\r\n");
      }

      function updateHeadersAndBodies() {
        const requestHeaders = document.getElementById("requestHeaders");
        const responseHeaders = document.getElementById("responseHeaders");
        const requestBody = document.getElementById("requestBody");
        const responseBody = document.getElementById("responseBody");

        // Parse request headers and body from raw data
        if (selectedRequest.raw) {
          try {
            const decodedRequest = atob(selectedRequest.raw);
            const headerEnd = decodedRequest.indexOf("\r\n\r\n");
            if (headerEnd !== -1) {
              const headerSection = decodedRequest.substring(0, headerEnd);
              const bodySection = decodedRequest.substring(headerEnd + 4);

              requestHeaders.textContent = headerSection;
              requestBody.textContent = bodySection
                ? prettifyContent(bodySection, headerSection)
                : "No request body";
            } else {
              // Try with single \n\n if \r\n\r\n not found
              const altHeaderEnd = decodedRequest.indexOf("\n\n");
              if (altHeaderEnd !== -1) {
                const headerSection = decodedRequest.substring(0, altHeaderEnd);
                const bodySection = decodedRequest.substring(altHeaderEnd + 2);
                requestHeaders.textContent = headerSection;
                requestBody.textContent = bodySection
                  ? prettifyContent(bodySection, headerSection)
                  : "No request body";
              } else {
                requestHeaders.textContent = decodedRequest;
                requestBody.textContent = "No request body";
              }
            }
          } catch (e) {
            console.error("Error parsing request:", e);
            requestHeaders.textContent = "Error parsing request headers: " + e.message;
            requestBody.textContent = "Error parsing request body: " + e.message;
          }
        } else {
          requestHeaders.textContent = "Request headers not available";
          requestBody.textContent = "Request body not available";
        }

        // Parse response headers and body from raw data
        if (selectedRequest.response && selectedRequest.response.raw) {
          try {
            const decodedResponse = atob(selectedRequest.response.raw);
            const headerEnd = decodedResponse.indexOf("\r\n\r\n");
            if (headerEnd !== -1) {
              const headerSection = decodedResponse.substring(0, headerEnd);
              const bodySection = decodedResponse.substring(headerEnd + 4);

              responseHeaders.textContent = headerSection;
              // Try to prettify and detect if it's JSON
              let prettified = bodySection
                ? prettifyContent(bodySection, headerSection)
                : "No response body";
              responseBody.textContent = prettified;

              // Add JSON node parsing button if JSON
              const responseBodyParent = responseBody.parentElement;
              let parseBtn = responseBodyParent.querySelector(
                ".parse-json-nodes-btn"
              );
              if (parseBtn) parseBtn.remove();
              let isJson = false;
              try {
                const contentType = headerSection.toLowerCase();
                if (
                  contentType.includes("application/json") ||
                  contentType.includes("text/json") ||
                  (bodySection &&
                    (bodySection.trim().startsWith("{") ||
                      bodySection.trim().startsWith("[")))
                ) {
                  JSON.parse(bodySection);
                  isJson = true;
                }
              } catch {}
              if (isJson) {
                parseBtn = document.createElement("button");
                parseBtn.textContent = "Parse stringified JSON nodes";
                parseBtn.className = "parse-json-nodes-btn";
                parseBtn.style =
                  "margin-bottom:10px;display:block;background:#222;color:#4a9eff;border:none;padding:8px 12px;border-radius:4px;cursor:pointer;font-size:13px;";
                responseBodyParent.insertBefore(parseBtn, responseBody);
                parseBtn.onclick = function () {
                  try {
                    let obj = JSON.parse(bodySection);
                    obj = parseStringifiedJsonNodes(obj);
                    responseBody.textContent = JSON.stringify(obj, null, 2);
                  } catch (e) {
                    responseBody.textContent =
                      "Error parsing stringified JSON nodes.";
                  }
                };
              }
              // Recursively parse stringified JSON nodes in an object/array
              function parseStringifiedJsonNodes(obj) {
                if (typeof obj === "string") {
                  try {
                    const parsed = JSON.parse(obj);
                    // Only parse if the result is an object or array
                    if (typeof parsed === "object" && parsed !== null) {
                      return parseStringifiedJsonNodes(parsed);
                    }
                  } catch {}
                  return obj;
                } else if (Array.isArray(obj)) {
                  return obj.map(parseStringifiedJsonNodes);
                } else if (typeof obj === "object" && obj !== null) {
                  const result = {};
                  for (const key in obj) {
                    if (Object.prototype.hasOwnProperty.call(obj, key)) {
                      result[key] = parseStringifiedJsonNodes(obj[key]);
                    }
                  }
                  return result;
                }
                return obj;
              }
            } else {
              // Try with single \n\n if \r\n\r\n not found
              const altHeaderEnd = decodedResponse.indexOf("\n\n");
              if (altHeaderEnd !== -1) {
                const headerSection = decodedResponse.substring(0, altHeaderEnd);
                const bodySection = decodedResponse.substring(altHeaderEnd + 2);
                responseHeaders.textContent = headerSection;
                responseBody.textContent = bodySection
                  ? prettifyContent(bodySection, headerSection)
                  : "No response body";
              } else {
                responseHeaders.textContent = decodedResponse;
                responseBody.textContent = "No response body";
              }
            }
          } catch (e) {
            console.error("Error parsing response:", e);
            responseHeaders.textContent = "Error parsing response headers: " + e.message;
            responseBody.textContent = "Error parsing response body: " + e.message;
          }
        } else {
          responseHeaders.textContent = "Response headers not available";
          responseBody.textContent = "Response body not available";
        }
      }

      function copyToClipboard(text) {
        if (navigator.clipboard) {
          navigator.clipboard.writeText(text);
        } else {
          // fallback for older browsers
          const textarea = document.createElement("textarea");
          textarea.value = text;
          document.body.appendChild(textarea);
          textarea.select();
          document.execCommand("copy");
          document.body.removeChild(textarea);
        }
      }

      // --- Column resizing logic ---
      function setupColumnResizing() {
        const mainTable = document.getElementById("mainRequestsTable");
        if (!mainTable) return;
        const colgroup = document.getElementById("mainColgroup");
        const resizers = mainTable.querySelectorAll(".col-resizer");
        let startX, startWidth, col, colIdx, hasMovedMouse = false;

        resizers.forEach((resizer, idx) => {
          resizer.onmousedown = function (e) {
            e.preventDefault();
            startX = e.pageX;
            hasMovedMouse = false;
            // The resizer is in column idx+1 (since first column has no resizer)
            // We want to resize column idx+1
            col = colgroup.children[idx + 1];
            const headerCell = resizer.parentElement;
            startWidth = headerCell.getBoundingClientRect().width;
            colIdx = idx + 1;
            document.body.style.cursor = "col-resize";
            document.onmousemove = onMouseMove;
            document.onmouseup = onMouseUp;
          };
        });

        function onMouseMove(e) {
          if (!col) return;
          let diff = e.pageX - startX;
          
          // Only start resizing if the mouse has actually moved
          if (Math.abs(diff) > 0) {
            if (!hasMovedMouse) {
              // First movement - convert to pixels to avoid unit mixing
              hasMovedMouse = true;
              col.style.width = startWidth + "px";
              const bodyColgroup = document.getElementById('bodyColgroup');
              if (bodyColgroup && bodyColgroup.children[colIdx]) {
                bodyColgroup.children[colIdx].style.width = startWidth + "px";
              }
            }
            
            let newWidth = Math.max(40, startWidth + diff);
            col.style.width = newWidth + "px";
            // Set for body colgroup as well
            const bodyColgroup = document.getElementById('bodyColgroup');
            if (bodyColgroup && bodyColgroup.children[colIdx]) {
              bodyColgroup.children[colIdx].style.width = newWidth + "px";
            }
          }
        }

        function onMouseUp() {
          document.body.style.cursor = "";
          document.onmousemove = null;
          document.onmouseup = null;
          col = null;
          hasMovedMouse = false;
        }
      }
      
      // --- Host filter popup trigger ---
      function setupHostFilterPopupButton() {
        const btn = document.getElementById('hostFilterBtn');
        if (!btn) return;
        btn.onclick = function(e) {
          e.stopPropagation();
          hostFilterPopupOpen = true;
          renderHostFilterUI();
        };
        // Hide popup on outside click (except popup itself)
        document.addEventListener('mousedown', function(ev) {
          const popup = document.querySelector('#hostFilterContainer > div:last-child');
          if (hostFilterPopupOpen && popup && !popup.contains(ev.target) && ev.target !== btn) {
            hostFilterPopupOpen = false;
            renderHostFilterUI();
          }
        });
      }
      // Call after DOMContentLoaded
      document.addEventListener("DOMContentLoaded", function() {
        setupColumnResizing();
        setupHostFilterPopupButton();
        syncColgroupWidths();
        window.addEventListener('resize', syncColgroupWidths);
      });
    </script>
  </body>
</html>
